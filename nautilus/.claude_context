# Mist Protocol - Nautilus TEE Implementation Context

## Project Overview
This is Nikola's track for implementing the Nautilus Trusted Execution Environment (TEE) component of Mist Protocol - a privacy-preserving DeFi protocol on Sui blockchain.

## What is Mist Protocol?
Mist Protocol enables **private swap intents** using:
1. **Seal** - Threshold encryption for user intents
2. **Nautilus TEE** - Verifiable computation in AWS Nitro Enclaves (THIS REPO)
3. **Sui Smart Contracts** - On-chain verification and settlement
4. **Walrus** - Decentralized blob storage

## Your Implementation: Nautilus TEE for Swap Execution

### Data Flow
```
User encrypts swap intent with Seal
    ↓
Submits to Sui blockchain
    ↓
Nautilus TEE receives encrypted intent
    ↓
1. Calls Seal servers to decrypt intent
2. Executes swap on Cetus DEX
3. Signs result with enclave's ephemeral key
    ↓
Returns signed proof to blockchain
    ↓
Smart contract verifies signature & PCR values
    ↓
Mints receipt NFT for user
```

### Key Components

**Input to TEE** (from blockchain):
```rust
ProcessIntentRequest {
    intent_id: String,           // Unique intent ID
    encrypted_data: String,      // Seal-encrypted SwapIntent
    key_id: String,             // Seal decryption key ID
}
```

**Decrypted Intent**:
```rust
SwapIntent {
    token_in: String,           // e.g., "USDC"
    token_out: String,          // e.g., "SUI"
    amount: u64,                // Amount to swap
    min_output: u64,            // Minimum acceptable output
    deadline: u64,              // Unix timestamp
}
```

**Output from TEE** (signed):
```rust
SwapExecutionResult {
    executed: bool,
    input_amount: u64,
    output_amount: u64,
    token_in: String,
    token_out: String,
    tx_hash: String,            // Sui transaction hash
}
```

### Network Endpoints Required

**Seal Servers** (for decryption):
- `seal-server-1.sui-testnet.io` (or actual Seal server endpoints)
- `seal-server-2.sui-testnet.io`
- Threshold: 2 servers needed

**Cetus DEX**:
- `fullnode.testnet.sui.io` (Sui RPC)
- Cetus API endpoints (TBD based on Cetus integration)

**AWS Resources**:
- Secrets Manager: Store Seal credentials
- Nitro Enclave: m5.xlarge instance
- IAM Role: Access to secrets

### Implementation Files

**Location**: `nautilus-framework/src/nautilus-server/src/apps/mist-protocol/`

**Files to create**:
1. `mod.rs` - Main TEE logic
2. `allowed_endpoints.yaml` - Network whitelist

**Key Functions**:
- `process_intent()` - Main endpoint (handles encrypted intent)
- `decrypt_with_seal()` - Calls Seal for decryption
- `execute_cetus_swap()` - Executes swap via Sui transaction
- `to_signed_response()` - Signs result with enclave key

### Security Properties

**Attestation** (proves TEE is running correct code):
- PCR0, PCR1, PCR2 values from reproducible build
- Registered on-chain in verifier contract
- Enclave's public key registered with attestation

**Verifiable Computation**:
- Enclave generates ephemeral key pair on boot
- Private key NEVER leaves the enclave
- All responses signed with this key
- Smart contract verifies signature matches registered key

### AWS Deployment

**Resources**:
- Profile: `nikola0x0-user`
- Region: `us-east-1`
- Key Pair: `nautilus-demo-key`
- Security Group: `instance-script-sg`

**Deployment Command**:
```bash
sh configure_enclave.sh mist-protocol
```

**Required IAM Permissions**:
- PowerUserAccess
- Custom IAM policy for role/instance profile management
- SecretsManagerReadWrite (for secrets)

### Current State

✅ **Completed**:
- AWS setup and IAM permissions configured
- Weather-example successfully deployed (reference implementation)
- Full deployment process documented in TROUBLESHOOTING.md
- Project structure organized

⏳ **Next Steps**:
1. Create `allowed_endpoints.yaml` with Seal + Cetus endpoints
2. Implement `mod.rs` with:
   - Data structures (ProcessIntentRequest, SwapIntent, SwapExecutionResult)
   - `process_intent()` endpoint
   - Seal decryption integration
   - Cetus DEX integration
   - Signature generation
3. Test locally (without NSM/attestation)
4. Deploy to AWS Nitro Enclave
5. Register enclave on-chain with attestation
6. Integrate with frontend

### Reference Implementation

**Weather Example** (already working):
- Location: `nautilus-framework-original/src/nautilus-server/src/apps/weather-example/`
- Shows: External API call, secret handling, signed responses
- Reference for: Structure, secret injection, endpoint patterns

### Important Notes

1. **Seal Integration**: Need to determine exact Seal API/protocol for decryption
2. **Cetus Integration**: Need to build Sui transactions for swaps
3. **Parent EC2 Proxy**: Enclave has NO internet - all network calls proxied through parent
4. **Secrets Management**: Store Seal credentials in AWS Secrets Manager
5. **Reproducible Builds**: Any code change requires rebuild and new PCR values

### Key Documents

- `IMPLEMENTATION_PLAN.md` - Detailed day-by-day plan
- `TROUBLESHOOTING.md` - Verified deployment process
- `PROJECT_STRUCTURE.md` - Directory organization
- `docs/MIST_PROTOCOL_DESIGN.md` - End-to-end system design
- `docs/NAUTILUS_FOR_MIST_PROTOCOL.md` - Integration design

### Quick Commands

```bash
# Start working
cd nautilus-framework/src/nautilus-server/src/apps/mist-protocol/

# Test locally (without attestation)
cd nautilus-framework/src/nautilus-server/
cargo run --features=mist-protocol --bin nautilus-server

# Deploy to AWS
cd nautilus-framework
export KEY_PAIR=nautilus-demo-key AWS_PROFILE=nikola0x0-user
sh configure_enclave.sh mist-protocol

# Test deployed enclave
curl -H 'Content-Type: application/json' \
  -d '{"payload": {...}}' \
  -X POST http://<PUBLIC_IP>:3000/process_intent
```

### Team Context

- **Your Track**: Nautilus TEE implementation
- **Other Tracks**: Frontend, Sui contracts, Seal integration
- **Integration Point**: TEE exposes HTTP endpoint, frontend calls it, contracts verify signatures

### Helpful Resources

- Nautilus Discord: https://discord.com/channels/916379725201563759/1361500579603546223
- Nautilus Docs: https://docs.sui.io/concepts/cryptography/nautilus
- Seal Docs: (on Sui)
- Cetus DEX: https://cetus.zone/

---

**Last Updated**: 2025-11-15 (After successful weather-example deployment)
**Status**: Ready to implement mist-protocol TEE logic
